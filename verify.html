<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minimal Verifier</title>
</head>
<body>
  <h2>QR Scanner Test</h2>
  <div id="reader" style="width:300px;"></div>
  <textarea id="payload" style="width:300px; height:80px;"></textarea><br>
  <button onclick="verify()">Verify</button>
  <p id="result"></p>

  <!-- ✅ Correct standalone QR Code Scanner Library -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <script>
    const publicKeyPem = `-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEAfW16OTCe9OxYXQauIe01bCx98AO
8uFzd3bcIq3nf4OxUz6JU3QXUh7JGC2jXWl0JyJhV2FmOd0lgxn4vnR1XA
-----END PUBLIC KEY-----`;

    async function importPublicKey(pem) {
      const bin = atob(pem.replace(/-----.*-----/g, "").replace(/\s/g, ""));
      const buf = new Uint8Array(bin.length);
      [...bin].forEach((ch, i) => buf[i] = bin.charCodeAt(i));
      return crypto.subtle.importKey(
        "spki", buf.buffer,
        { name: "ECDSA", namedCurve: "P-256" },
        false, ["verify"]
      );
    }

    function fromB64uStr(s){
      if(!s) return null;
      s = s.replace(/-/g,'+').replace(/_/g,'/');
      while (s.length % 4) s += '=';
      return atob(s);
    }

    async function verify() {
      const payloadBox = document.getElementById("payload");
      const resultBox = document.getElementById("result");
      try {
        const payload = JSON.parse(fromB64uStr(payloadBox.value));
        const data = new TextEncoder().encode(payload.id);
        const sig = Uint8Array.from(atob(payload.sig.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));

        const pubKey = await importPublicKey(publicKeyPem);
        const ok = await crypto.subtle.verify({ name:"ECDSA", hash:"SHA-256" }, pubKey, sig, data);

        resultBox.textContent = ok ? `✅ Authentic Product ID: ${payload.id}` : "❌ Invalid Signature";
      } catch {
        resultBox.textContent = "❌ Invalid Payload";
      }
    }

    // QR Scanner setup
    function onScanSuccess(decodedText) {
      const pValue = decodedText.includes("p=") ? decodedText.split("p=")[1] : decodedText;
      document.getElementById("payload").value = pValue;
      verify();
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      }
    });
  </script>
</body>
</html>

